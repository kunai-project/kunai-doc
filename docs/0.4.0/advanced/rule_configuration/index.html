<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-0.4.0 plugin-docs plugin-id-default docs-doc-id-advanced/rule_configuration">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Configuration with Rules | Kunai</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kunai.rocks/img/kunai-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kunai.rocks/img/kunai-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kunai.rocks/docs/0.4.0/advanced/rule_configuration"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="0.4.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-0.4.0"><meta data-rh="true" name="docsearch:version" content="0.4.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-0.4.0"><meta data-rh="true" property="og:title" content="Configuration with Rules | Kunai"><meta data-rh="true" name="description" content="Using Kunai to monitor every single event happening on a system is nice as it gives a very deep insight of what is going on. However, this approach generates loads of events. While it might be the way to go for some Kunai users, some others might be interested into detecting only very specific events (based on configurable rules) and show only those ones. This is exactly the topic we are going to tackle in this section of the documentation."><meta data-rh="true" property="og:description" content="Using Kunai to monitor every single event happening on a system is nice as it gives a very deep insight of what is going on. However, this approach generates loads of events. While it might be the way to go for some Kunai users, some others might be interested into detecting only very specific events (based on configurable rules) and show only those ones. This is exactly the topic we are going to tackle in this section of the documentation."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kunai.rocks/docs/0.4.0/advanced/rule_configuration"><link data-rh="true" rel="alternate" href="https://kunai.rocks/docs/0.4.0/advanced/rule_configuration" hreflang="en"><link data-rh="true" rel="alternate" href="https://kunai.rocks/docs/0.4.0/advanced/rule_configuration" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kunai RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kunai Atom Feed"><link rel="stylesheet" href="/assets/css/styles.86b19f83.css">
<link rel="preload" href="/assets/js/runtime~main.9fe2bef2.js" as="script">
<link rel="preload" href="/assets/js/main.9e3399c8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">‚≠êÔ∏è If you like Kunai, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/kunai-project/kunai">GitHub</a> and follow us on social medias</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Kunai" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Kunai" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Kunai</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/0.4.0/quickstart">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/0.4.0/quickstart">0.4.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/advanced/rule_configuration">üöß Unstable üöß</a></li><li><a class="dropdown__link" href="/docs/advanced/rule_configuration">0.5.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/0.4.0/advanced/rule_configuration">0.4.0</a></li><li><a class="dropdown__link" href="/docs/0.3.0/advanced/rule_configuration">0.3.0</a></li><li><a class="dropdown__link" href="/docs/0.2.0/advanced/rule_configuration">0.2.0</a></li><li><a class="dropdown__link" href="/docs/0.1.0/quickstart">0.1.0</a></li></ul></div><a href="https://github.com/kunai-project/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/0.4.0/quickstart">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/0.4.0/installation">Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/0.4.0/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/0.4.0/cli">CLI Usage</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/0.4.0/events/">Explore Kunai Events</a><button aria-label="Toggle the collapsible sidebar category &#x27;Explore Kunai Events&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/0.4.0/advanced/">Threat Detection Usage</a><button aria-label="Toggle the collapsible sidebar category &#x27;Threat Detection Usage&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/0.4.0/advanced/rule_configuration">Configuration with Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.4.0/advanced/ioc_configuration">Builtin IoC matching</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/0.4.0/compatibility">Compatibility</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Kunai<!-- --> <b>0.4.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/advanced/rule_configuration">latest version</a></b> (<!-- -->0.5.0<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/0.4.0/advanced/"><span itemprop="name">Threat Detection Usage</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Configuration with Rules</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 0.4.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Configuration with Rules</h1></header><p>Using <strong>Kunai</strong> to monitor every single event happening on a system is nice as it gives a very deep insight of what is going on. However, this approach generates loads of events. While it might be the way to go for some <strong>Kunai</strong> users, some others might be interested into detecting only very specific events (based on configurable rules) and show only those ones. This is exactly the topic we are going to tackle in this section of the documentation.</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>When <strong>Kunai</strong> is configured with some detection/filtering rules, <strong>ONLY</strong> the events matching at least one rule will be shown.</p><p>If an event is <strong>not desired</strong> prefer <a href="/docs/0.4.0/configuration#configuration-file"><strong>disabling it in configuration</strong></a> rather than <strong>filtering it out</strong>, it will <strong>save resources</strong>.</p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>We intentionally do not go too deep into the rule format as it will be part of a dedicated documentation in the <a href="https://github.com/0xrawsec/gene-rs" target="_blank" rel="noopener noreferrer">gene-rs project</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="detection-rules">Detection Rules<a href="#detection-rules" class="hash-link" aria-label="Direct link to Detection Rules" title="Direct link to Detection Rules">‚Äã</a></h2><p>Detection rules are made to detect <strong>suspicious/malicious security events</strong> happening on a running system. </p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p><strong>detection rules</strong> will make modifications to the matching events to provide information about the matching rule(s)</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">‚Äã</a></h3><p>Here after you can find an example of a detection rule to detect an <code>execve</code> event with a task name looking like
a typical Linux kernel task name. This is a technique sometimes used by malware to hide themselves.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#6c6783"># name of the rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> mimic.kthread</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># default type is detection so the following line is not mandatory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">type</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> detection</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># metadata information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">meta</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># tags of the rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">tags</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&#x27;os:linux&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># MITRE ATT&amp;CK¬†ids</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">attack</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> T1036 </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># authors of the rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">authors</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> qjerome </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># comments about the rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">comments</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">-</span><span class="token plain"> tries to catch binaries masquerading kernel threads</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># acts as a pre-filter to speed up engine</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">match-on</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">events</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token comment" style="color:#6c6783"># we match on kunai execve and execve_script events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token key atrule" style="color:#ffcc99">kunai</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain">execve</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> execve_script</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">matches</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># 0x200000 is the flag for KTHREAD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$task_is_kthread</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .info.task.flags </span><span class="token important" style="font-weight:bold;color:#c4b9fe">&amp;=</span><span class="token plain"> &#x27;0x200000&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># common kthread names </span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$kthread_names</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .info.task.name ~= &#x27;^(kworker)&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># if task is NOT a KTHREAD but we have a name that </span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># looks like one we want the rule to kick-in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">condition</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> not $task_is_kthread and $kthread_names</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># severity is bounded to 10¬†so it is the maximum score</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">severity</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you want to try the above rule and see
how <strong>Kunai</strong> behaves when loaded with detection rules, you can do it easily:</p><ol><li>dump the above rule in a file</li><li>run <code>sudo kunai -r path_to_your_file</code></li><li>open another terminal and trigger the rule by executing <code>cp /usr/bin/ls /tmp/kworker &amp;&amp; /tmp/kworker</code></li></ol><p>If you have made the experiment, you may have noted that when the rule matches the event is modified and contains a new section named <code>detection</code>. </p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>View modified event</summary><div><div class="collapsibleContent_i85q"><p></p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;ancestors&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/lib/systemd/systemd|/usr/bin/login|/usr/bin/zsh|/usr/bin/bash|/usr/bin/xinit|/usr/bin/i3|/usr/bin/bash|/usr/bin/urxvt|/usr/bin/zsh&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/bin/zsh&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/tmp/kworker&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;path&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/tmp/kworker&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;md5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;5a657abb15a5c469936ec86f420f7b39&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha1&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;5d08746413e0e5f3242fe768266e39796007ca2d&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha256&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;b97ab6fabafba27199d50a190a2ad6513ccf8ee722558e86d2a45fd2ac535c67&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha512&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;eed4577694e87932beff79898f7abe5dfb672b7d4d4c02a57d86f96f62826f92bdd1514c80e0329d4f9861946cfb80563584074d64fbaf4ce2ee386f28d55433&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;size&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">137848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;detection&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;rules&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token string" style="color:#ffcc99">&quot;mimic.kthread&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;tags&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token string" style="color:#ffcc99">&quot;os:linux&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;attack&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token string" style="color:#ffcc99">&quot;T1036&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;severity&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;execve&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;d21cc4e6-35f9-4193-e879-84fdd4ce74f3&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;batch&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kworker&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;pid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1368247</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;tgid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1368247</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;guuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;2d83bc47-d838-0300-a6a2-85b0b7e01400&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1000</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;gid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1000</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;namespaces&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token property" style="color:#9a86fd">&quot;mnt&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">4026531841</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;flags&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x400000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;zsh&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;pid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">302186</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;tgid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">302186</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;guuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;1ce53685-7339-0000-a6a2-85b06a9c0400&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1000</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;gid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1000</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;namespaces&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token property" style="color:#9a86fd">&quot;mnt&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">4026531841</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;flags&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x400000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;utc_time&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;2023-12-11T10:04:49.301495661Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p></p></div></div></details><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><ul><li>if several rules match a single event, rule name(s) will appear in <code>.detection.rules</code></li><li>matching rules&#x27; <code>tags</code> and <code>attack</code> (MITRE ATT&amp;CK) ids will stack up respectively in <code>.detection.tags</code> and <code>.detection.attack</code></li><li>severities of <strong>rules matching</strong> are summed and put in <code>.detection.severity</code>. Severity is bounded to <strong>10</strong>.</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="filtering-rules">Filtering Rules<a href="#filtering-rules" class="hash-link" aria-label="Direct link to Filtering Rules" title="Direct link to Filtering Rules">‚Äã</a></h2><p>Filtering rules on the other hand are made to <strong>select</strong> the logs we want <strong>Kunai</strong> to show.
With those you can be very granular on the kind of logs you want to filter in/out.
The difference between a detection and a filtering rule is very little, it is just a switch
to toggle in the rule.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Events matching <strong>ONLY filtering rules</strong> will be shown <strong>as is</strong>, which means that there will
not be any <code>detection</code> section in the event.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-1">Example<a href="#example-1" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">‚Äã</a></h3><p>Let&#x27;s design a filtering rule to log every <code>mprotect_exec</code> event but the ones made by
a browser. Indeed any software using JIT¬†is very likely to turn some memory pages protection
to execute code.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p><code>mprotect_exec</code> are interesting events to detect dynamic
code execution, such as shellcode. However, those events may be very noisy if you
have a browser running or any application making extensive use of JIT. So the following example
can be used as a base for a custom configuration to observe unknown <code>mprotect_exec</code> events.</p></div></div><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> log.mprotect_exec</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># type to set to use the rule as a filter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">type</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> filter</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">match-on</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">events</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token comment" style="color:#6c6783"># applies on kunai mprotect_exec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token key atrule" style="color:#ffcc99">kunai</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> mprotect_exec </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">matches</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># exe matches regex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$browser</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .data.exe.path ~= &#x27;/usr/lib/(firefox/firefox</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">chromium/chromium)&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># if exe is neither firefox nor chromium</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">condition</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> not $browser</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><ul><li>Adapt the <code>$browser</code> match if needed</li><li>You can try to reverse the condition (remove <code>not</code>) and see the difference</li></ul></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>In case several <strong>filtering rules</strong> are specified, it is a <strong>OR</strong> relationship between them. This means, if a rule is supposed to <strong>exclude</strong> an event but another <strong>includes</strong> it, the event will be shown. So for <strong>filtering rules</strong> it is a good practice to create <strong>one rule</strong> per <strong>event type</strong> we want to <strong>include</strong>.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="realistic-example">Realistic Example<a href="#realistic-example" class="hash-link" aria-label="Direct link to Realistic Example" title="Direct link to Realistic Example">‚Äã</a></h3><p>Let&#x27;s create a <strong>filtering configuration</strong> that logs <strong>everything</strong> except some noisy events.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> include.all.but.noisy</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">type</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> filter</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">match-on</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token key atrule" style="color:#ffcc99">events</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token comment" style="color:#6c6783"># we can put - in front of the events we don&#x27;t want this rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token comment" style="color:#6c6783"># to apply on. The following means, everything except </span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token comment" style="color:#6c6783"># mprotect_exec and prctl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token key atrule" style="color:#ffcc99">kunai</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&#x27;-mprotect_exec&#x27;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&#x27;-prctl&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># rule with no condition always returns true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># Rules have OR relationship between them so here after we keep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># ONLY some specific mprotect_exec we want to see, all others</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># being excluded by the rule above</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> log.mprotect_exec</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">type</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> filter</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">match-on</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">events</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token comment" style="color:#6c6783"># applies on kunai mprotect_exec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token key atrule" style="color:#ffcc99">kunai</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> mprotect_exec </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">matches</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># exe matches regex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$browser</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .data.exe.path ~= &#x27;/usr/lib/(firefox/firefox</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">chromium/chromium)&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># if exe is neither firefox nor chromium</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">condition</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> not $browser</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rule-composition">Rule Composition<a href="#rule-composition" class="hash-link" aria-label="Direct link to Rule Composition" title="Direct link to Rule Composition">‚Äã</a></h2><p>Rules can be composed of other rules to simplify their creation, reduce redundancy, and improve performance:</p><ul><li><strong>Modularity</strong>:<ul><li>Define a rule once and reuse it in multiple composite rules.</li><li>Fixing a single base rule is easier than updating several duplicates.</li></ul></li><li><strong>Simplicity</strong>:<ul><li>Splitting complex logic into smaller, reusable rules makes them easier to understand and maintain.</li></ul></li><li><strong>Performance</strong>:<ul><li>A rule can only match an event once, making it more efficient than duplicating frequent matches across multiple rules.</li></ul></li></ul><p>Rules used in others can be of <strong>type</strong> <a href="#detection-rules"><code>detection</code></a>, <a href="#filtering-rules"><code>filter</code></a>, or <code>dependency</code>.</p><p>A <code>dependency</code> rule has the following properties:  </p><ol><li>It must be <strong>loaded</strong> prior to the rules using it.</li><li>It <strong>matches</strong> only when referenced in another rule.  </li><li>Its <code>tags</code>, <code>severity</code>, and <code>actions</code> sections are ignored and do not affect scan results.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-2">Example<a href="#example-2" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">‚Äã</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#6c6783"># we define here a dependency rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># NB: if this rule is used in several others it will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># be evaluated only once per event scanned.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> dep.run.tmpfs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># rule type to make the rule a dependency</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">type</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> dependency</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">matches</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$a</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .data.ancestors ~= &#x27;\</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">(/tmp/</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">/dev/shm/</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">/run/</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">/var/(run</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">lock)/)\</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token punctuation" style="color:#6c6783">?</span><span class="token plain">&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$p</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .data.exe.path ~= &#x27;^(/tmp/</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">/dev/shm/</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">/run/</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">/var/(run</span><span class="token punctuation" style="color:#6c6783">|</span><span class="token plain">lock)/)&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># $a is the slowest so run last</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">condition</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> $p or $a</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">---</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># we define a detection rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> run.tmpfs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">meta</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">tags</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&#x27;os:linux&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">attack</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> T1027.011 </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">authors</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> qjerome </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">comments</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">-</span><span class="token plain"> if something is running in tmpfs it is suspicious and we should stack up</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">matches</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token comment" style="color:#6c6783"># we use the dependency we just defined above</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$t</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> rule(dep.run.tmpfs) </span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">condition</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> $t</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">severity</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="trigger-actions-on-events">Trigger Actions on Events<a href="#trigger-actions-on-events" class="hash-link" aria-label="Direct link to Trigger Actions on Events" title="Direct link to Trigger Actions on Events">‚Äã</a></h2><p>It is possible to tell <strong>Kunai</strong> to take <strong>actions</strong> on some events. Actions can be defined both in <strong>filtering</strong> and <strong>detection</strong> rules. The only difference is that some actions are not supported for <strong>filtering</strong> rules. For example it is not allowed to use a <strong>kill</strong> action within a <strong>filtering</strong> rule.</p><p>To list the available <strong>actions</strong> as well as their <strong>description</strong>, run:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">kunai config --list-actions</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-kill-a-process">Example: Kill a Process<a href="#example-kill-a-process" class="hash-link" aria-label="Direct link to Example: Kill a Process" title="Direct link to Example: Kill a Process">‚Äã</a></h3><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#6c6783"># this is a condensed version of the rule defined previously</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># killing the process instead of letting it run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> mimic.kthread</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">match-on</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">events</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token key atrule" style="color:#ffcc99">kunai</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain">execve</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> execve_script</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">matches</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$task_is_kthread</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .info.task.flags </span><span class="token important" style="font-weight:bold;color:#c4b9fe">&amp;=</span><span class="token plain"> &#x27;0x200000&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$kthread_names</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .info.task.name ~= &#x27;^(kworker)&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">condition</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> not $task_is_kthread and $kthread_names</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">severity</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">actions</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> kill </span><span class="token punctuation" style="color:#6c6783">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>dump the rule in a file <code>rule.yaml</code></li><li>run kunai with <code>kunai run -r rule.yaml</code></li><li>open another terminal and trigger the rule by executing <code>cp /usr/bin/ls /tmp/kworker &amp;&amp; /tmp/kworker -R /</code></li><li><strong>observe</strong> the following:<ul><li>a kunai event is generated as it comes from a detection</li><li>a <strong>warning log</strong> is printed showing a process got killed</li><li>our <strong>fake malicious</strong> process has been <strong>killed</strong></li></ul></li></ol><div class="theme-admonition theme-admonition-danger alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Use <code>kill</code> action <strong>with extreme care</strong>! Kunai runs with high privileges and can kill
any process. </p><p>Use it only if you are sure there is no false positives to
the detection rule.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-scan-files">Example: Scan Files<a href="#example-scan-files" class="hash-link" aria-label="Direct link to Example: Scan Files" title="Direct link to Example: Scan Files">‚Äã</a></h3><p>Similarly one can decide to <strong>scan files on-demand</strong>. There are two possibilities currently supported for file scanning:</p><ol><li><strong>Kunai</strong> has been <a href="/docs/0.4.0/configuration">configured</a> to load <a href="https://virustotal.github.io/yara-x/" target="_blank" rel="noopener noreferrer">Yara</a> rules<ul><li>a <a href="/docs/0.4.0/events/file_scan"><code>file_scan</code></a> event will be generated with <code>.data.signatures</code> containing any <strong>Yara signature</strong> match and <code>.data.positives</code> indicating the <strong>number of matching rules</strong></li></ul></li><li><strong>Kunai</strong> has <strong>not</strong> been configured to load <strong>Yara</strong> rules<ul><li>in such case a <a href="/docs/0.4.0/events/file_scan"><code>file_scan</code></a> event will be generated but <code>.data.signature</code> field will always be <strong>empty</strong> and <code>.data.positives</code> will always be <code>0</code>. This options might be interesting if one wants to get <strong>metadata</strong> information of some files without the burden of <strong>Yara</strong> file scanning.</li></ul></li></ol><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>When a <strong>file scan</strong> is issued <strong>any path</strong> contained in the event is scanned. So in most of the cases it will result in several <a href="/docs/0.4.0/events/file_scan"><code>file_scan</code></a> events being generated.</p></div></div><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#6c6783"># this rule scans any bash script written on disk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> scan.any.bash.script.write</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">type</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain">¬†filter</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">match-on</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">events</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token key atrule" style="color:#ffcc99">kunai</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> write_close </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">matches</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">$bash_ext</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> .data.path ~= &#x27;\.sh$&#x27;</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">condition</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> all of them</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">actions</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> scan</span><span class="token punctuation" style="color:#6c6783">-</span><span class="token plain">files </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">name</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> show.file_scan</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token key atrule" style="color:#ffcc99">match-on</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token key atrule" style="color:#ffcc99">events</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token key atrule" style="color:#ffcc99">kunai</span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"> file_scan </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To test the above rule:</p><ol><li>write the above rule in a file <code>/tmp/scan.yaml</code></li><li>Run kunai with <code>write_close</code> events <strong>enabled</strong> and load the rule file</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">kunai run </span><span class="token parameter variable" style="color:#ffcc99">--include</span><span class="token plain"> write_close </span><span class="token parameter variable" style="color:#ffcc99">-r</span><span class="token plain"> /tmp/scan.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Drop a <code>bash</code> script somewhere and execute it</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;ls -hail&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">&gt;</span><span class="token plain"> /tmp/test.sh </span><span class="token operator" style="color:#e09142">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">chmod</span><span class="token plain"> +x /tmp/test.sh </span><span class="token operator" style="color:#e09142">&amp;&amp;</span><span class="token plain"> /tmp/test.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>observe that <strong>two</strong> <a href="/docs/0.4.0/events/file_scan"><code>file_scan</code></a> events got printed</li></ol><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>To scan <strong>dropped files</strong> you must use <a href="/docs/0.4.0/events/write_close"><code>write_close</code></a> events as those
indicate the file <strong>has been closed</strong> and de-facto cannot be written again
until it gets re-opened.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="memo-about-kunai-rules">Memo about <strong>Kunai</strong> Rules<a href="#memo-about-kunai-rules" class="hash-link" aria-label="Direct link to memo-about-kunai-rules" title="Direct link to memo-about-kunai-rules">‚Äã</a></h2><ol><li>rules are written in <a href="https://yaml.org/" target="_blank" rel="noopener noreferrer">YAML</a></li><li>several rules can be defined in a single file (see <a href="https://yaml.org/spec/1.2.2/#chapter-9-document-stream-productions" target="_blank" rel="noopener noreferrer">YAML documents</a>)<ul><li>put <strong>a line</strong> with <code>---</code> before rule starts and <strong>a line</strong>  with <code>...</code> after rule ends</li></ul></li><li>one can use <strong>Kunai</strong> with rules either from <a href="/docs/0.4.0/configuration#configuration-file">config</a> or from <a href="/docs/0.4.0/configuration#advanced-cli-usage">cli</a></li><li>a rule can be one of these types <a href="#detection-rules"><code>detection</code></a>,<a href="#filtering-rules"><code>filter</code></a> or <a href="#rule-composition"><code>dependency</code></a><ul><li><code>detection</code> rules output event with <strong>detection information</strong> in <code>.detection</code> section</li><li><code>filter</code> rules output event <strong>as is</strong></li><li><code>dependency</code> rule are evaluated only when used in <strong>other rule types</strong> </li></ul></li><li><code>match-on</code> section is <strong>very important</strong> as it allows to quickly filter events</li><li>every <code>match</code> in <code>matches</code> must be in the form <code>$VAR_NAME: FIELD_PATH OPERATOR &#x27;VALUE&#x27;</code><ul><li><code>FIELD_PATH</code>:¬†<strong>field&#x27;s absolute path</strong> starting with <code>.</code>, separated by <code>.</code></li><li><code>OPERATOR</code>: <ul><li><code>==</code> : <strong>equality operator</strong></li><li><code>&gt;=</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&lt;</code> : <strong>comparison operators</strong> <!-- -->‚Üí<!-- --> <code>VALUE</code> must be a <strong>number</strong></li><li><code>&amp;=</code> : <strong>flag checking operator</strong> <!-- -->‚Üí<!-- --> <code>VALUE</code> must be a <strong>number</strong></li><li><code>~=</code> : <strong>regex operator</strong> <!-- -->‚Üí<!-- --> <code>VALUE</code> must be a <strong>string</strong> regex following <a href="https://docs.rs/regex/latest/regex/#syntax" target="_blank" rel="noopener noreferrer">syntax</a></li></ul></li><li>every <strong>field value</strong> found at <code>FIELD_PATH</code> is expected to be of the same type than <code>VALUE</code></li></ul></li><li><code>condition</code> defines the <strong>logic</strong> to apply on the <strong>matches</strong>:<ul><li><code>not</code>, <code>and</code> and <code>or</code> keywords</li><li>support for <strong>aggregated notation</strong>:<ul><li><code>all of them</code>: all the variable must be <code>true</code></li><li><code>all of $VAR_PREFIX</code>: all variables <strong>starting with VAR_PREFIX</strong> must be <code>true</code></li><li><code>N of them</code>: <code>N</code> variables must be <code>true</code></li><li><code>N of $VAR_PREFIX</code>: <code>N</code> variables <strong>starting with VAR_PREFIX</strong> must be <code>true</code></li><li><code>none of them</code>: <strong>None</strong> of the variables must be <code>true</code> (all <code>false</code>)</li><li><code>none of $VAR_PREFIX</code>: <strong>None</strong> of the variables <strong>starting with VAR_PREFIX</strong> must be <code>true</code></li></ul></li></ul></li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kunai-project/kunai-doc/tree/main/versioned_docs/version-0.4.0/advanced/rule_configuration.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/0.4.0/advanced/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Threat Detection Usage</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/0.4.0/advanced/ioc_configuration"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Builtin IoC matching</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#detection-rules" class="table-of-contents__link toc-highlight">Detection Rules</a><ul><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li></ul></li><li><a href="#filtering-rules" class="table-of-contents__link toc-highlight">Filtering Rules</a><ul><li><a href="#example-1" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#realistic-example" class="table-of-contents__link toc-highlight">Realistic Example</a></li></ul></li><li><a href="#rule-composition" class="table-of-contents__link toc-highlight">Rule Composition</a><ul><li><a href="#example-2" class="table-of-contents__link toc-highlight">Example</a></li></ul></li><li><a href="#trigger-actions-on-events" class="table-of-contents__link toc-highlight">Trigger Actions on Events</a><ul><li><a href="#example-kill-a-process" class="table-of-contents__link toc-highlight">Example: Kill a Process</a></li><li><a href="#example-scan-files" class="table-of-contents__link toc-highlight">Example: Scan Files</a></li></ul></li><li><a href="#memo-about-kunai-rules" class="table-of-contents__link toc-highlight">Memo about <strong>Kunai</strong> Rules</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/quickstart">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/AUMaBvHvNU" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://infosec.exchange/@kunai_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/kunai-project" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/kunai_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">X/Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kunai-project/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2025 Kunai Project, Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9fe2bef2.js"></script>
<script src="/assets/js/main.9e3399c8.js"></script>
</body>
</html>