<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">BPFDoor case study | Kunai</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kunai.rocks/img/kunai-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kunai.rocks/img/kunai-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kunai.rocks/blog/bpf-door-case-study"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="BPFDoor case study | Kunai"><meta data-rh="true" name="description" content="This blog post is meant to give an insight of how to use Kunai for detection engineering."><meta data-rh="true" property="og:description" content="This blog post is meant to give an insight of how to use Kunai for detection engineering."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-11-02T13:37:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/qjerome"><meta data-rh="true" property="article:tag" content="malware,detection-engineering"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kunai.rocks/blog/bpf-door-case-study"><link data-rh="true" rel="alternate" href="https://kunai.rocks/blog/bpf-door-case-study" hreflang="en"><link data-rh="true" rel="alternate" href="https://kunai.rocks/blog/bpf-door-case-study" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kunai RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kunai Atom Feed"><link rel="stylesheet" href="/assets/css/styles.86b19f83.css">
<link rel="preload" href="/assets/js/runtime~main.a29cf6e6.js" as="script">
<link rel="preload" href="/assets/js/main.780fa583.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">‚≠êÔ∏è If you like Kunai, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/kunai-project/kunai">GitHub</a> and follow us on social medias</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Kunai" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Kunai" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Kunai</b></a><a class="navbar__item navbar__link" href="/docs/quickstart">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/quickstart">0.6.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/quickstart">üöß Unstable üöß</a></li><li><a class="dropdown__link" href="/docs/quickstart">0.6.0</a></li><li><a class="dropdown__link" href="/docs/0.5.0/quickstart">0.5.0</a></li><li><a class="dropdown__link" href="/docs/0.4.0/quickstart">0.4.0</a></li><li><a class="dropdown__link" href="/docs/0.3.0/quickstart">0.3.0</a></li><li><a class="dropdown__link" href="/docs/0.2.0/quickstart">0.2.0</a></li><li><a class="dropdown__link" href="/docs/0.1.0/quickstart">0.1.0</a></li></ul></div><a href="https://github.com/kunai-project/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kunai-vs-io_uring">Kunai vs io_uring</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/02/kunai-malware-sandboxing">Enhancing Detection Engineering with Automated Malware Sandboxing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/04/19/kunai-misp">Using your MISP IoC in Kunai</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/bpf-door-case-study">BPFDoor case study</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/announcing-kunai">Announcing Kunai</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">BPFDoor case study</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-11-02T13:37:00.000Z" itemprop="datePublished">November 2, 2023</time> ¬∑ <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/qjerome.png" alt="Quentin Jerome"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Quentin Jerome</span></a></div><small class="avatar__subtitle" itemprop="description">Kunai Maintainer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>This blog post is meant to give an insight of how to use Kunai for detection engineering.</p><p>For those who didn&#x27;t have the opportunity to attend the Kunai workshop at <a href="https://hack.lu" target="_blank" rel="noopener noreferrer">Hack.lu 2023 edition</a> this is a way to catch up on a big part of what we have been doing during this session. For those who actually attended the workshop, you can take a read anyway because the post goes even more into the details, as we were limited in time.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="about-the-sample-studied-in-this-post">About the Sample Studied in this Post<a href="#about-the-sample-studied-in-this-post" class="hash-link" aria-label="Direct link to About the Sample Studied in this Post" title="Direct link to About the Sample Studied in this Post">‚Äã</a></h2><p><strong>BPFDoor</strong> has been chosen for this case study as it has been described, when it got discovered, as something not trivial to detect. The difficulties to detect mostly being depicted as the fact that it uses BPF based packet filtering to implement a nice backdoor. I will not deep dive in the description of what this malware is doing and how it works. If you want to know more about those topics, please find a non-exhaustive list of related posts and documents about BPFDoor malware in <a href="#about-bpfdoor">references section</a>.</p><table><tr><td><b>Filename</b></td><td>bpfdoor.mwr</td></tr><tr><td><b>md5</b></td><td>0017f7b913ce66e4d80f7e78cf830a2b</td></tr><tr><td><b>sha1</b></td><td>f1bf775746a5c882b9ec003617b2a70cf5a5b029</td></tr><tr><td><b>sha256</b></td><td>fa0defdabd9fd43fe2ef1ec33574ea1af1290bd3d763fdb2bed443f2bd996d73</td></tr><tr><td><b>sha512</b></td><td>ff5dd28ba3f5ce1f85f85fa9b65f9f30fbd300f2ca238cb2713da7077b7a0a8ff094cff4d7de9381726925abdd9ea065fa75ccd02fa5a816b71a6f91479363c1</td></tr></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-description">Experiment Description<a href="#experiment-description" class="hash-link" aria-label="Direct link to Experiment Description" title="Direct link to Experiment Description">‚Äã</a></h2><p>You can find here after the methodology followed in order to make our experiment. This methodology is not specific to this sample, so it can be used to study any malware you want with <strong>Kunai</strong>.</p><ol><li>Run <strong>Kunai</strong> in such a way you capture the output (redirect output to file or configure output file)</li><li>Run malware</li><li>Interact with the malware if needed/possible</li></ol><p>For the sake of simplicity, I¬†have prepared everything for you. You can find the Kunai&#x27;s output for this sample in the following file <a target="_blank" href="/assets/files/bpfdoor-e85e848ecc643661710a0f843ab98b5e.jsonl">bpfdoor.jsonl</a>. To improve the readability of that file, it went through a step of filtering so that it contains only the events related to the sample.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>re-doing the experiments yourself</div><div class="admonitionContent_S0QG"><p>It is possible, but you have to known that the events in the file got generated with the latest git (under development) version of <strong>Kunai</strong>. Therefore, some events will be missing if you take the latest release (i.e. <strong>0.1.0</strong>).</p></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>running BPFDoor</div><div class="admonitionContent_S0QG"><ul><li>run the sample as priviledged user otherwise it won&#x27;t work</li><li>the malware checks if an instance already running (you can know that by inspecting the source code or <strong>stracing</strong> the process)</li></ul></div></div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>running malware must be done with care</div><div class="admonitionContent_S0QG"><ul><li>always do it in a dedicated machine (i.e. VM), preferably <strong>isolated</strong> from the Internet</li><li>Linux container isolation is not enough (the kernel is shared between host and containers)</li><li>it is always better to know a bit what to expect from the sample (i.e. make sure it does not exploit your hypervisor)</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-suspicious-events">The Suspicious Events<a href="#the-suspicious-events" class="hash-link" aria-label="Direct link to The Suspicious Events" title="Direct link to The Suspicious Events">‚Äã</a></h2><p>The aim of this analysis is not necessarily to understand exactly what the malware is doing, as it can be achieved by other means (sandboxing, strace ...). The goal is to identify actionable events, on which we can build efficient detection rules. </p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>suspicious events</div><div class="admonitionContent_S0QG"><p>The notion of a suspicious event is sometimes universal, sometimes subjective and sometimes depends on the context. So you might find more/less events suspicious than me while you look at the logs. Anyway any detection rule built on top of those events should be tested before being put into production.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-story-of-a-weird-command-line">The Story of a Weird Command Line<a href="#the-story-of-a-weird-command-line" class="hash-link" aria-label="Direct link to The Story of a Weird Command Line" title="Direct link to The Story of a Weird Command Line">‚Äã</a></h3><p>The first event which should really catch our attention is the following. We see that a binary <code>/tmp/bpfdoor.mwr</code>, which should be qualified as unknown in a real infection, runs a rather suspicious one-liner command line.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;ancestors&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/lib/systemd/systemd|/usr/sbin/sshd|/usr/sbin/sshd|/usr/sbin/sshd|/usr/bin/bash|/usr/bin/sudo|/usr/bin/su|/usr/bin/bash|/tmp/bpfdoor.mwr&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/tmp/bpfdoor.mwr&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;sh -c /bin/rm -f /dev/shm/kdmtmpflush;/bin/cp ./bpfdoor.mwr /dev/shm/kdmtmpflush &amp;&amp; /bin/chmod 755 /dev/shm/kdmtmpflush &amp;&amp; /dev/shm/kdmtmpflush --init &amp;&amp; /bin/rm -f /dev/shm/kdmtmpflush&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;file&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/bin/dash&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;md5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;1e6b1c887c59a315edb7eb9a315fc84c&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha1&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;803ffdb71aa236aa25009bef97db1b8ad0e3c62b&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha256&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;64e48365207d0c19008ba7d53d75c0de3fcd5a1590e4c40fc69c677663fedc20&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha512&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0d261d7a8d615d080e20f1e1b294f168107dc2740da1a037d9519215e67e7a72dcc0f56c0006e5fdc04b7dbbd339171e9d2bf15f8e31f295d37aff499e1bc928&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;size&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">129816</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;execve&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;8f2fab25-ef70-3898-b52e-da2eaca820cc&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;batch&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">27</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We clearly understand from this command line that the sample is copying itself to <code>/dev/shm</code> with a new name, changes its permissions, executes the new file and deletes it straight after. What else do we need to trigger the alarm ? This is already a good start, so lets extract some ideas out of this and continue our journey.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>/dev/shm</div><div class="admonitionContent_S0QG"><p>This is usually a <strong>tmpfs</strong> (in memory) filesystem so files running from that place will not persist on disk. Copying itself there, before executing and deleting itself could be seen as an attempt to evade malware cleaning run by an AV or any protection software.</p></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>detection takeaways</div><div class="admonitionContent_S0QG"><ul><li>a command line with <code>cp</code>, <code>chmod</code>, <code>exec</code>, <code>rm</code> happening in this order might be considered as a suspicious one-liner<ul><li>increase severity if <code>ancestors</code> contains a binary of a service exposed on the Internet</li><li>increase severity if <code>command_line</code> contains <code>/dev/shm</code></li></ul></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="not-leaving-traces-is-suspicious">Not Leaving Traces is Suspicious<a href="#not-leaving-traces-is-suspicious" class="hash-link" aria-label="Direct link to Not Leaving Traces is Suspicious" title="Direct link to Not Leaving Traces is Suspicious">‚Äã</a></h3><p>The next event looking suspicious is the following and is strongly linked to the previous one. As it is the execution of the malware after it copied itself into <code>/dev/shm</code>.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;ancestors&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/lib/systemd/systemd|/usr/sbin/sshd|/usr/sbin/sshd|/usr/sbin/sshd|/usr/bin/bash|/usr/bin/sudo|/usr/bin/su|/usr/bin/bash|/tmp/bpfdoor.mwr|/usr/bin/dash&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/bin/dash&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/dev/shm/kdmtmpflush --init&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;file&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/dev/shm/kdmtmpflush&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;md5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha1&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha256&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha512&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;size&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;error&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;file not found&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;execve&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;38789315-0485-9af9-f511-27fe97b21a1c&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;batch&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">43</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>What makes that event suspicious is that <strong>Kunai</strong>, did not managed to compute hashing information out of the executable path. The reason for this is simple, and the event is self explanatory, the <strong>file is not found</strong>. As we have seen previously the malware deletes the file straight after the execution. This type of things (quickly modifying a file) after its execution races <strong>Kunai</strong>, and this is sad. I will not go into the technical details but this is not really something we can change. However, the important thing is that when such thing happens <strong>Kunai</strong> tells it to you. So even if some information is missing from that event, we can still use it as a reliable source of suspiciousness.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>detection takeaways</div><div class="admonitionContent_S0QG"><ul><li>a binary for which we could not compute hashing information is suspicious, it means the file got modified/deleted straight after its execution</li><li>a binary running from <code>/dev/shm</code> with priviledged user</li><li>a known bad hash (not directly applicable to this event but to any event containing hashing information)</li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="changing-its-own-task-name">Changing its own Task Name<a href="#changing-its-own-task-name" class="hash-link" aria-label="Direct link to Changing its own Task Name" title="Direct link to Changing its own Task Name">‚Äã</a></h3><p>The next suspicious candidate is the malware changing its task name. It does it using the <code>prctl</code> syscall, passing the <code>PR_SET_NAME</code> option as a first argument.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/dev/shm/kdmtmpflush&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/dev/shm/kdmtmpflush --init&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;option&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;PR_SET_NAME&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg2&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x605368&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg3&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x0&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg4&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x6e75722d646c6168&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x3&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;success&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ffcc99">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">7</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;prctl&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;c8be60da-fa83-4a6c-aa8a-cbf1d38f8520&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;batch&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">45</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;hald-runner&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token comment" style="color:#6c6783">// this is the new task name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;pid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1747</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;tgid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1747</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;guuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;7d64f958-4500-0000-82bb-77d6d3060000&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;gid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;namespaces&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token property" style="color:#9a86fd">&quot;mnt&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">4026531840</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;flags&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x00400000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Changing task name cannot be considered as suspicious per se, you would probably see a lot of processes cloning/forking, changing their task names. So we have to use a bit more the data of this event to identify whether it is suspicious or not. We can observe two suspicious things though:</p><ul><li>our good old <code>/dev/shm</code> friend being in executable path</li><li><code>hald-runner</code> being used as a new task name, this is clearly an attempt to mimic a legit process/service task name in order to fool people looking at running processes</li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>detection takeaways</div><div class="admonitionContent_S0QG"><ul><li>a binary located in <code>/dev/shm</code> changing its task name should raise an alert</li><li>a task name being changed to mimic a legit binary</li><li>it might be interesting to tag unknown (non whitelisted) binaries doing this and understand why they do so</li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attaching-bpf-filter-on-a-raw-socket--bonus">Attaching BPF Filter on a Raw Socket + Bonus<a href="#attaching-bpf-filter-on-a-raw-socket--bonus" class="hash-link" aria-label="Direct link to Attaching BPF Filter on a Raw Socket + Bonus" title="Direct link to Attaching BPF Filter on a Raw Socket + Bonus">‚Äã</a></h3><p>Finally, the one we all expected and which gave its name to that malware ! We see that the executable is attaching a BPF¬†filter to a raw socket <code>SOCK_RAW</code>.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;hald-runner&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/dev/shm/kdmtmpflush&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;socket&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;domain&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;AF_PACKET&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;type&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;SOCK_RAW&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;filter&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;md5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;19c9f9f52a7d7bf1f9c26dc57034873b&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha1&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;c97c5ad700f7426432dbe4d6478f362714e835f0&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha256&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;1a23f76646d1741946afd2d6d3ce3d0deae14198b544b09322a540c345953988&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha512&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;af9fce79e05316999ae3ef82ea7a04ce299c611cb46e27154e455b9f9bea42631a5293dd42cb0d332d5e10b8ed924930321cb3433b7989e6fe9042d97338d477&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;len&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">30</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;size&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">240</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;attached&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ffcc99">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">22</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;bpf_socket_filter&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;839aa10e-243a-3238-b221-9f7d0c1cac95&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;batch&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">51</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;hald-runner&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;pid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1748</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;tgid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1748</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;guuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;ff313459-4500-0000-82bb-77d6d4060000&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;gid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;namespaces&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token property" style="color:#9a86fd">&quot;mnt&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">4026531840</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;flags&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x00400140&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;systemd&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token comment" style="color:#6c6783">// this is init on this system</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;pid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;tgid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;guuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;4b0dc405-0000-0000-82bb-77d601000000&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;gid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;namespaces&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token property" style="color:#9a86fd">&quot;mnt&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">4026531840</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;flags&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x00400100&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;utc_time&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;2023-09-05T09:33:07.600987330Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Attaching a BPF¬†filter to a raw socket is definitely something suspicious ! But another thing interesting can be observed in this event. Our malware has suddently <code>systemd</code> as <code>parent_task</code>, while previously it was itself <code>hald-runner</code> (you have to look at the logs to verify that). So what the hell, happened ?</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>zombie process</div><div class="admonitionContent_S0QG"><p>A zombie process, is a process still running while it&#x27;s parent is dead. When that happens the Linux Kernel makes the <code>init</code> process become the parent of the zombie process. Becoming a zombie is not something usually done on purpose as it is often the symptom of a bug. But if you are a malware you might use that trick to make people think your parent process is <code>init</code> binary (systemd in my case) and that you are a legitimate service.</p></div></div><p>So this zombie process information is definitely something we can use to detect something strange is going on. In the log file, this event is the only one you will see with <code>systemd</code> as parent. This is because after that event the malware listen up for packets arriving on the raw socket. But don&#x27;t worry, I¬†can guarantee that any subsequent activity of this malware would have exactly the same anomaly and would give you even more opportunities to catch it.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>detection takeaways</div><div class="admonitionContent_S0QG"><ul><li>a binary attaching a BPF¬†filter to a <code>SOCK_RAW</code></li><li>a binary attaching a BPF¬†filter to a socket<ul><li>increase severity if running in <code>/dev/shm</code></li><li>increase severity if task name changed<ul><li>increase severity if mimics a legit service</li></ul></li></ul></li><li>any zombie process (parent_task became init pid=1)<ul><li>increase severity if running in <code>/dev/shm</code> or unknown service binary</li></ul></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="going-further-for-even-more-detection-possibilities">Going Further, for Even More Detection Possibilities<a href="#going-further-for-even-more-detection-possibilities" class="hash-link" aria-label="Direct link to Going Further, for Even More Detection Possibilities" title="Direct link to Going Further, for Even More Detection Possibilities">‚Äã</a></h3><p>If you looked at the logs, you have probably noticed that the <a href="#attaching-bpf-filter-on-a-raw-socket--bonus">previous event</a> we described is one of the last interesting things we see. Afer, everything looks to cleanup events. This is not all with this malware at all, as you may have also observed that the task with pid 1748 didn&#x27;t exit.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">root@ebpf-ubuntu-20:/tmp# ps aux | grep 1748</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">root        1748  0.0  0.0   2496    84 ?        Ss   Sep05   0:00 hald-runner</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the task listening on the raw socket and waiting for commands. So the malware is still running and all we have analyzed so far are only the events generated when the malware is spawned on a system, we did not interact with the malware whatsoever. This is because I¬†did not take the time to reverse-engineer the sample to know the password it expects when it receives packets on its raw socket. </p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>homework</div><div class="admonitionContent_S0QG"><ul><li>reverse the sample, find the key and send expected packets to the sample</li><li>compile the malware from <a href="https://github.com/gwillgues/BPFDoor/blob/main/bpfdoor.c" target="_blank" rel="noopener noreferrer">sources</a> (not guaranteed of being the exact same one) with a key you know and send packets to the sample</li></ul></div></div><p>What we can see from the <a href="https://github.com/gwillgues/BPFDoor/blob/main/bpfdoor.c" target="_blank" rel="noopener noreferrer">BPFDoor sources</a>, is that we can expect even more detection possibilities:</p><ul><li>the sample runs specific <code>iptables</code> commands</li><li>it again changes task name, to <code>/usr/libexec/postfix/master</code></li><li>it can execute abitrary commands and very likely suspicious ones, which should not be ran from anything else than an interactive shell (<code>whoami</code>, <code>cat</code> ...). Programmers usually prefer using APIs rather than parsing shell outputs.</li><li>we would see a binary located in <code>/dev/shm</code> communicating over the network</li></ul><p>Another blind spot we have in this analysis is the original infection vector. I may have missed it but I¬†didn&#x27;t find this information online either. Anyway, what is important here is that knowing the infection vector would have been very likely an additional way to catch this sample. This is purely fictional but if we assume it went through a web server compromise, we would have seen at some point a <code>/dev/shm/kdmtmpflush</code> <a href="/docs/events/execve">execve event</a> with a web server binary being in it&#x27;s <code>ancestors</code> field.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>detection takeaways</div><div class="admonitionContent_S0QG"><ul><li>something executed from <code>/dev/shm</code> running commands<ul><li>increase severity if running commands such as <code>iptables</code>, <code>whoami</code>, <code>cat</code></li></ul></li><li>a binary using a shell to execute commands (might need some whitelisting)</li><li>something running in <code>/dev/shm</code> communicating over the Internet</li><li>any service that has an exposed port on the Internet executing an unexpected binary</li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bonus-detecting-the-mistakes-made-by-bpfdoor-authors">Bonus: Detecting the Mistakes made by BPFDoor Authors<a href="#bonus-detecting-the-mistakes-made-by-bpfdoor-authors" class="hash-link" aria-label="Direct link to Bonus: Detecting the Mistakes made by BPFDoor Authors" title="Direct link to Bonus: Detecting the Mistakes made by BPFDoor Authors">‚Äã</a></h3><p>Something I¬†observed while running several times this BPFDoor sample is that it sometimes renames its task with something containing <code>/</code> (the Linux path separator). Such an example can be observed below. </p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/dev/shm/kdmtmpflush&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/dev/shm/kdmtmpflush --init&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;option&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;PR_SET_NAME&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg2&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x605368&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg3&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x0&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg4&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x8&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;arg5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;0x3&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;success&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ffcc99">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">7</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;prctl&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token comment" style="color:#6c6783">// new task name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/sbin/conso&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is even more obvious when looking at the <a href="https://github.com/gwillgues/BPFDoor/blob/main/bpfdoor.c" target="_blank" rel="noopener noreferrer">malware source code</a>, the name of the process is changed by randomly picking an entry in the following array.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token keyword" style="color:#ffcc99">char</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">*</span><span class="token plain">self</span><span class="token punctuation" style="color:#6c6783">[</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;/sbin/udevd -d&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;/sbin/mingetty /dev/tty7&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;/usr/sbin/console-kit-daemon --no-daemon&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;hald-addon-acpi: listening on acpi kernel interface /proc/acpi/event&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;dbus-daemon --system&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;hald-runner&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;pickup -l -t fifo -u&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;avahi-daemon: chroot helper&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;/sbin/auditd -n&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token string" style="color:#ffcc99">&quot;/usr/lib/systemd/systemd-journald&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This caught my attention because this is not something you see very often in Linux and luckily for us there is a good explaination for that. The Linux Kernel, when performing execve it calls <a href="https://elixir.bootlin.com/linux/latest/C/ident/begin_new_exec" target="_blank" rel="noopener noreferrer">begin_new_exec</a>, itself calling <a href="https://elixir.bootlin.com/linux/latest/source/fs/exec.c#L1366" target="_blank" rel="noopener noreferrer">__set_task_comm(me, kbasename(bprm-&gt;filename), true)</a>. What it does is simple, <code>__set_task_comm</code> assigns the new task name with <code>kbasename(some_filename)</code>. And guess what, <a href="https://elixir.bootlin.com/linux/latest/C/ident/kbasename" target="_blank" rel="noopener noreferrer">kbasename</a> is actually taking the <a href="https://en.wikipedia.org/wiki/Basename" target="_blank" rel="noopener noreferrer">basename</a> out of a path.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>task name is always <strong>16 bytes</strong> so any longer string is truncated. This is why in our event we see task name <code>/usr/sbin/conso</code>instead of <code>/usr/sbin/console-kit-daemon --no-daemon</code></p></div></div><p>All this to say that it should not be considered as normal to have a task name containing <code>/</code>. The <code>PR_SET_NAME</code> option of the prctl syscall is meant to change the task name. By convention (this is not enforced) task names does not contain any <code>/</code>. So it is not really a mis-use of the <code>prctl</code> syscall the malware authors did but they rather forgot/didn&#x27;t know that Linux task name are not supposed to contain <code>/</code>. This anomaly could be used to detect such a bad programming practice, that I hope is seen only in malware !</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>detection takeaways</div><div class="admonitionContent_S0QG"><ul><li>a task name containing <code>/</code> is abnormal (programming mistake)</li><li>a task name not contained in the <code>exe</code> filename is suspicious for unknown binary. Some whitelisting would be needed as threaded programs often rename their threads with custom names.</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2><p>Assuming we have Kunai running on our machine, would it be complicated to detect this kind of sample knowing what we know now ? I would say no as there are enough suspicious things we can rely on and which should not trigger that many false positives.</p><p>This is always easy to say that we can detect things a posteriori. In order to have a chance to catch such sample in the wild, relevant generic rules and eventually heuristics need to be built. This is why it is very important to make as much as possible this kind of exercise as it would help us filling the gaps in detection rules. Sorry for all the guys who think they are protected because they bought an expensive commercial solution but you&#x27;d have to do this kind of work too, especially if you are a valuable target to attackers. I will not argue for hours about this but the main argument is that commercial solution are not bad per se, but they have to be generic enough to satisfy the more use cases as possible. Satisfying use cases is usually synonym of not having too many false positives, at the cost of discarding some true positives under some very specific/targetted environment. So if you have a commercial solution, do this job and enrich your detection rules, it won&#x27;t be lost and you will probably make one of your engineers happy to use his brain.</p><p>In the reports, everyone tends to agree on one thing: this kind of malware is difficult to detect. Is it a question of stealthiness of the malware ? I¬†don&#x27;t think so, because we have seen it does a lot of very suspicious things, and we can expect many others (we did not interact with the shell). I rather think the issue is the lack of visibility most of the people have, at least those who cannot afford an EDR. So according to this absolutely impartial argument, it gives you a very good reason to use <strong>Kunai</strong>.</p><p>Happy Threat Detection and Hunting</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="about-bpfdoor">About BPFDoor<a href="#about-bpfdoor" class="hash-link" aria-label="Direct link to About BPFDoor" title="Direct link to About BPFDoor">‚Äã</a></h3><ul><li><a href="https://github.com/gwillgues/BPFDoor/blob/main/bpfdoor.c" target="_blank" rel="noopener noreferrer">Source code (probably not exactly the same one)</a></li><li><a href="https://www.countercraftsec.com/blog/a-step-by-step-bpfdoor-compromise/" target="_blank" rel="noopener noreferrer">https://www.countercraftsec.com/blog/a-step-by-step-bpfdoor-compromise/</a></li><li><a href="https://exatrack.com/public/Tricephalic_Hellkeeper.pdf" target="_blank" rel="noopener noreferrer">https://exatrack.com/public/Tricephalic_Hellkeeper.pdf</a></li><li><a href="https://www.trendmicro.com/en_us/research/23/g/detecting-bpfdoor-backdoor-variants-abusing-bpf-filters.html" target="_blank" rel="noopener noreferrer">https://www.trendmicro.com/en_us/research/23/g/detecting-bpfdoor-backdoor-variants-abusing-bpf-filters.html</a></li></ul></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/malware">malware</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/detection-engineering">detection-engineering</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/kunai-project/kunai-doc/tree/main/blog/2023-11-02-bpf-door/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2024/04/19/kunai-misp"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Using your MISP IoC in Kunai</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/announcing-kunai"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Announcing Kunai</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#about-the-sample-studied-in-this-post" class="table-of-contents__link toc-highlight">About the Sample Studied in this Post</a></li><li><a href="#experiment-description" class="table-of-contents__link toc-highlight">Experiment Description</a></li><li><a href="#the-suspicious-events" class="table-of-contents__link toc-highlight">The Suspicious Events</a><ul><li><a href="#the-story-of-a-weird-command-line" class="table-of-contents__link toc-highlight">The Story of a Weird Command Line</a></li><li><a href="#not-leaving-traces-is-suspicious" class="table-of-contents__link toc-highlight">Not Leaving Traces is Suspicious</a></li><li><a href="#changing-its-own-task-name" class="table-of-contents__link toc-highlight">Changing its own Task Name</a></li><li><a href="#attaching-bpf-filter-on-a-raw-socket--bonus" class="table-of-contents__link toc-highlight">Attaching BPF Filter on a Raw Socket + Bonus</a></li><li><a href="#going-further-for-even-more-detection-possibilities" class="table-of-contents__link toc-highlight">Going Further, for Even More Detection Possibilities</a></li><li><a href="#bonus-detecting-the-mistakes-made-by-bpfdoor-authors" class="table-of-contents__link toc-highlight">Bonus: Detecting the Mistakes made by BPFDoor Authors</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a><ul><li><a href="#about-bpfdoor" class="table-of-contents__link toc-highlight">About BPFDoor</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/quickstart">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/AUMaBvHvNU" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://infosec.exchange/@kunai_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/kunai-project" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/kunai_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">X/Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kunai-project/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><section><svg width="322.105" height="65.01" viewBox="0 0 322.105 65.01" xml:space="preserve" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" style="height:4em"><defs><g id="d"><g id="b"><path id="a" d="M0 0v1h.5Z" transform="rotate(18 3.157 -.5)"></path><use xlink:href="#a" transform="scale(-1 1)"></use></g><g id="c"><use xlink:href="#b" transform="rotate(72)"></use><use xlink:href="#b" transform="rotate(144)"></use></g><use xlink:href="#c" transform="scale(-1 1)"></use></g></defs><path fill="#039" d="M0 0h97.514v65.01H0z"></path><g fill="#fc0" transform="matrix(3.61165 0 0 3.61165 48.757 32.505)"><use xlink:href="#d" y="-6"></use><use xlink:href="#d" y="6"></use><g id="e"><use xlink:href="#d" x="-6"></use><use xlink:href="#d" transform="rotate(-144 -2.344 -2.11)"></use><use xlink:href="#d" transform="rotate(144 -2.11 -2.344)"></use><use xlink:href="#d" transform="rotate(72 -4.663 -2.076)"></use><use xlink:href="#d" transform="rotate(72 -5.076 .534)"></use></g><use xlink:href="#e" transform="scale(-1 1)"></use></g><text xml:space="preserve" style="font-weight:700;font-size:24px;line-height:1.15;font-family:&#x27;Roboto Mono for Powerline&#x27;;-inkscape-font-specification:&#x27;Roboto Mono for Powerline Bold&#x27;;text-align:start;letter-spacing:0;word-spacing:0;text-anchor:start;fill:#039;fill-opacity:1" x="124.358" y="29.436" transform="translate(-14.865 -4.455)"><tspan x="124.358" y="29.436" style="font-style:normal;font-variant:normal;font-weight:700;font-stretch:normal;font-size:24px;line-height:1.1;font-family:&#x27;Nimbus Sans&#x27;;-inkscape-font-specification:&#x27;Nimbus Sans Bold&#x27;;letter-spacing:-.8px;word-spacing:-.15px;fill:#039;fill-opacity:1">Co-funded by</tspan><tspan x="124.358" y="57.036" style="font-style:normal;font-variant:normal;font-weight:700;font-stretch:normal;font-size:24px;line-height:1.1;font-family:&#x27;Nimbus Sans&#x27;;-inkscape-font-specification:&#x27;Nimbus Sans Bold&#x27;;letter-spacing:-.8px;word-spacing:-.15px;fill:#039;fill-opacity:1">the European Union</tspan></text></svg></section><div class="footer__copyright">Copyright ¬© 2025 Kunai Project, Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a29cf6e6.js"></script>
<script src="/assets/js/main.780fa583.js"></script>
</body>
</html>