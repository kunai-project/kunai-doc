<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | Kunai</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kunai.rocks/img/kunai-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kunai.rocks/img/kunai-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kunai.rocks/blog"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Kunai"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kunai.rocks/blog"><link data-rh="true" rel="alternate" href="https://kunai.rocks/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://kunai.rocks/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Kunai RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Kunai Atom Feed"><link rel="stylesheet" href="/assets/css/styles.86b19f83.css">
<link rel="preload" href="/assets/js/runtime~main.4fe196cd.js" as="script">
<link rel="preload" href="/assets/js/main.9b770a5a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Kunai" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Kunai" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Kunai</b></a><a class="navbar__item navbar__link" href="/docs/quickstart">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/quickstart">0.2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/quickstart">Unstable</a></li><li><a class="dropdown__link" href="/docs/quickstart">0.2.0</a></li><li><a class="dropdown__link" href="/docs/0.1.0/quickstart">0.1.0</a></li></ul></div><a href="https://github.com/kunai-project/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/02/kunai-malware-sandboxing">Enhancing Detection Engineering with Automated Malware Sandboxing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/04/19/kunai-misp">Using your MISP IoC in Kunai</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bpf-door-case-study">BPFDoor case study</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/announcing-kunai">Announcing Kunai</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2024/10/02/kunai-malware-sandboxing">Enhancing Detection Engineering with Automated Malware Sandboxing</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-10-02T00:00:00.000Z" itemprop="datePublished">October 2, 2024</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/qjerome.png" alt="Quentin Jerome"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Quentin Jerome</span></a></div><small class="avatar__subtitle" itemprop="description">Kunai Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In the complex field of incident response, effective training for Security Operations Center (SOC) operators is critical. One of the key challenges in SOC training is providing realistic, data-driven environments that accurately simulate the threats and incidents operators will face. Additionally, detection engineers need reliable and actionable data to create robust detection rules that align with real-world security monitoring systems. However, gathering and analyzing real-world malware samples, which is essential to this process, can be time-consuming and prone to errors when done manually.</p><p>In this blog post, we introduce an approach to solving these challenges through automation. We explore how a Kunai-based sandbox can streamline the collection and analysis of malware samples, offering a practical solution.</p><p>By leveraging this sandbox infrastructure, the project opens up new opportunities for more efficient malware analysis while supporting a wide range of CPU architectures, including those specific to IoT and mobile devices.</p><h1>The Need for Realistic Data</h1><p>One prerequisite for offering cyber ranges or training solutions in the context of detection engineering and security monitoring is the collection of real-world malware samples. </p><p>To provide high-quality training and realistic experiences, these samples can be used as injects in various training scenarios or for testing detection rules.</p><p>A common approach is to collect such data manually by running and monitoring malware samples, preferably in a confined environment such as a virtual machine (VM). However, this approach has several drawbacks: it lacks reproducibility under identical experimental conditions and involves repetitive, error-prone tasks (uploading files, running monitoring tools/malware samples, monitoring network traffic, conducting post-analysis, etc.). </p><p>Thus, this process is an ideal candidate for automation. Our first motivation for creating this new project is to address these challenges. Our second goal is to provide detection engineers with a reliable way to generate <strong>actionable data</strong> from malware samples.</p><h1>The Concept of a Kunai-Based Sandbox</h1><p>Malware sample sandboxing is a frequent task performed at various stages of a security alert&#x27;s lifecycle, from incident/malware triage to more detailed malware analysis. This task is typically supported by numerous tools, ranging from open-source options like <a href="https://github.com/kevoreilly/CAPEv2/" target="_blank" rel="noopener noreferrer">Cape Sandbox</a> to paid alternatives like <a href="https://www.joesandbox.com/#windows" target="_blank" rel="noopener noreferrer">Joe Sandbox</a>, <a href="https://www.vmray.com/" target="_blank" rel="noopener noreferrer">VMRay</a>, or <a href="https://any.run/" target="_blank" rel="noopener noreferrer">Any Run</a>.</p><p>While these solutions are excellent in many respects—such as defeating anti-sandboxing techniques and providing deep insight into a sample&#x27;s capabilities—we believe they are not always the best tools for gathering actionable information for detection engineers. For many organizations, there is no direct mapping between the data collected from malware analysis platforms (sandboxes) and their monitoring systems. As a result, a task that should be simple—building detection rules tailored to an organization’s security monitoring tools—can become challenging.</p><p>To solve this issue, we propose a simple yet powerful sandboxing infrastructure based on <a href="https://www.qemu.org/" target="_blank" rel="noopener noreferrer">QEMU</a> for virtualization and <a href="https://github.com/kunai-project/kunai" target="_blank" rel="noopener noreferrer">Kunai</a> for sample monitoring. This infrastructure can serve multiple purposes: analyzing malware samples using the same tools employed for detection and collecting data for use within the NGSOTI project.</p><p><img loading="lazy" src="/assets/images/sandbox-diagram-406745f357919f0e3820fcbbf1305e0b.png" width="850" height="463" class="img_ev3q"></p><h1>Project Status</h1><p>The source code for the project is available in the <a href="https://github.com/kunai-project/sandbox/" target="_blank" rel="noopener noreferrer">Kunai sandbox repository</a>. Additionally, our under-construction open dataset, extracted using this sandbox, can be found at <a href="https://helga.circl.lu/NGSOTI/malware-dataset" target="_blank" rel="noopener noreferrer">NGSOTI malware dataset</a>.</p><p>Currently, the sandboxing system can run Linux malware samples within a virtual environment, monitor them using <a href="https://github.com/kunai-project/kunai" target="_blank" rel="noopener noreferrer">Kunai</a>, and capture the network traffic generated by the system. Another key feature of our sandbox is its support for multiple CPU architectures (currently <strong>Intel 32/64bits</strong> and <strong>ARM 64bits</strong>), enabling the analysis of a broader range of malware samples. We believe <strong>ARM</strong> achitecture support is crucial, as it can be used to analyze malware samples specific to <strong>IoT</strong> or <strong>mobile</strong> (phones, tablets, etc.) devices.</p><h1>Limitations</h1><p>While our approach provides a great opportunity for detection engineers to obtain data that is directly usable for creating <a href="https://github.com/kunai-project/kunai" target="_blank" rel="noopener noreferrer">Kunai-based</a> detection rules, we must remember that it does not achieve the same level of stealthiness as other sandboxing platforms, which often rely on custom hypervisors. Therefore, our approach should not be considered a replacement for dedicated sandboxing platforms but rather a complement that facilitates detection engineering-related tasks.</p><h1>Conclusion</h1><p>The NGSOTI project aims to bridge the gap between theoretical knowledge and practical skills for SOC operators by offering realistic, data-driven training experiences. By automating the collection and analysis of malware samples through the Kunai-based sandbox, we provide a straightforward, efficient, and repeatable method for detection engineers to generate actionable insights. This approach is not intended to replace traditional sandboxing but rather to complement it. With support for multiple CPU architectures, including those specific to IoT and mobile devices, the sandbox expands the possibilities for analyzing and generating data from a wider range of malware, enhancing the diversity of scenarios that NGSOTI can offer. As the project progresses, we look forward to further enriching the open dataset and continuing to develop solutions that address the evolving challenges in detection engineering.</p><h1>References</h1><ul><li><a href="https://github.com/kunai-project/sandbox" target="_blank" rel="noopener noreferrer">Kunai project - sandbox</a></li><li><a href="https://helga.circl.lu/NGSOTI/malware-dataset" target="_blank" rel="noopener noreferrer">NGSOTI - malware-dataset</a></li></ul><h1>Funding</h1><p>The NGSOTI project is dedicated to training the next generation of Security Operation Center (SOC) operators, focusing on the human aspect of cybersecurity. It underscores the significance of providing SOC operators with the necessary skills and open-source tools to address challenges such as detection engineering, incident response, and threat intelligence analysis. Involving key partners such as CIRCL, Restena, Tenzir, and the University of Luxembourg, the project aims to establish a real operational infrastructure for practical training. This initiative integrates academic curricula with industry insights, offering hands-on experience in cyber ranges.</p><p>NGSOTI is co-funded under Digital Europe Programme (DEP) via the ECCC (European cybersecurity competence network and competence centre).</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/detection-engineering">detection-engineering</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/malware">malware</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sandbox">sandbox</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2024/04/19/kunai-misp">Using your MISP IoC in Kunai</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-04-19T00:00:00.000Z" itemprop="datePublished">April 19, 2024</time> · <!-- -->9 min read</div></header><div class="markdown" itemprop="articleBody"><p><a href="https://www.misp-project.org" target="_blank" rel="noopener noreferrer">MISP</a> is an <strong>open-source</strong> cyber-threat information sharing platform which has been adopted by many actors of the industry over the last years. Organizations usually use it to exchange information about their own IT security incidents or about their Cyber Threat Intelligence (CTI) activities. Therefore a <strong>MISP</strong> instance, well connected with other instances, can quickly become a real gold mine containing a massive amount of <strong>Indicators of Compromise (IoC)</strong>. By essence <strong>IoC</strong> are very specific and can be used to quickly identify compromised systems. In this blog post we are going to detail how to easily use <strong>IoC</strong> stored in a <strong>MISP</strong> instance to configure <strong>Kunai</strong> for real time compromise detection.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="warm-up">Warm up<a href="#warm-up" class="hash-link" aria-label="Direct link to Warm up" title="Direct link to Warm up">​</a></h2><p>The first step to do  is to get familiar with the kind of events <strong>Kunai</strong> is able to monitor on your system. So please, take a quick read over the <a href="/docs/category/kunai---events">events documentation</a>, in order to better understand the following steps. Additionally, the reader may want to get familiar with the documentation explaining how to use the tool for <a href="/docs/advanced/">threat detection purposes</a>.</p><p>For those not having the time to go through the whole documentation, nothing beats a good example. So below one can find the example of an <code>execve_script</code> event generated <strong>for every</strong> script being executed on a system running <strong>Kunai</strong>.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;ancestors&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/lib/systemd/systemd|/usr/bin/login|/usr/bin/zsh|/usr/bin/bash|/usr/bin/xinit|/usr/bin/i3|/usr/bin/bash|/usr/bin/urxvt|/usr/bin/zsh|/usr/bin/bash&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/bin/bash&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/bin/bash /tmp/tmp.msdKnvj7ax_kunai_test.sh&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;file&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/tmp/tmp.msdKnvj7ax_kunai_test.sh&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;md5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;64b8185d28042ea96feb251e12fe632b&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha1&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;31683c67b020d90f02a42e43e7758184ef98c12f&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha256&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;cda81b42b75647daf6b70a626380c199fe665d721e63bfe34c96b65da0289627&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha512&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;63165b902db5242a01296b39c1d6f2995fde961e29d9470d1862ccde8e2c8a3083659bf5d9c0794bbca620f37c419baec3c1d1941333d37fb9ced795553d2e83&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;size&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">21</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;interpreter&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;file&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/bin/bash&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;md5&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;e742da46d05de5afca58a2abcba5343e&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha1&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;8d48bdcb10eb85a0bd80c34e13fc01c2f6776043&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha256&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;664428e8dd065099a20cb364bdc293dd8f787ef10b9454b64e127a197950a5d6&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;sha512&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;b4e6f555571636f02704271d3a40b8470d04447ca3aaad073818f4041d944533bfbca0d5586dc945a2de8033f8fd4123f4203219e9c7b97ebbc52acd340e598f&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;size&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1112880</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;host&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;...&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">2</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;execve_script&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;520487fc-020c-5569-ed88-38393e49a2d2&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;batch&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">32</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;...&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;...&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;utc_time&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;2024-02-13T08:34:29.312127521Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see, every <strong>Kunai</strong> event is composed of fields of various types. Some of these types can directly be matched against <strong>IoCs</strong>, following this correspondence table:</p><table><thead><tr><th align="center">Kunai data types</th><th align="center">cover IoC type</th></tr></thead><tbody><tr><td align="center">path</td><td align="center">absolute path</td></tr><tr><td align="center">md5, sha1, sha256, sha512</td><td align="center">hash</td></tr><tr><td align="center">domain / fqdn</td><td align="center">domain / fqdn</td></tr><tr><td align="center">IP address</td><td align="center">IPv4 / IPv6</td></tr></tbody></table><p>So any field of <strong>any Kunai event</strong> having a type in the above table will be checked against the <strong>IoCs</strong> loaded in the tool. Now the only thing we have to do is to feed <strong>Kunai</strong> with data in the expected <strong>IoC</strong> format. The format is pretty basic, yet flexible - the tool simply expects a file containing <strong>JSON</strong> documents. One can find an example file below:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;81050c82-68a5-4130-a56d-a465c8337066&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;My MISP Instance&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;value&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;why.kunai.rocks&quot;</span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">{</span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;dd19ecd1-8237-427a-9b1d-35ff7d17381f&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;My MISP Instance&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;value&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;kunai.rocks&quot;</span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The format is simple enough to accommodate any <strong>IoC</strong> feed and is easily scriptable. So one could even imagine the creation of such a file from an IP list found on the Internet.</p><p>Now, the reader should have a good picture of the topic and we can walk through a small experiment to get a bit more familiar with <strong>Kunai</strong> and its <strong>IoC</strong> matching capabilities.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-little-experiment">A Little Experiment<a href="#a-little-experiment" class="hash-link" aria-label="Direct link to A Little Experiment" title="Direct link to A Little Experiment">​</a></h2><p>Let&#x27;s run <strong>Kunai</strong> without any arguments, merely taking care of redirecting its output:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token function" style="color:#9a86fd">sudo</span><span class="token plain"> kunai </span><span class="token operator" style="color:#e09142">|</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">tee</span><span class="token plain"> /tmp/kunai.log</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># if one has jq installed one can pipe kunai output to jq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># in order to get a prettier output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token function" style="color:#9a86fd">sudo</span><span class="token plain"> kunai </span><span class="token operator" style="color:#e09142">|</span><span class="token plain"> jq </span><span class="token string" style="color:#ffcc99">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">|</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">tee</span><span class="token plain"> /tmp/kunai.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should start seeing some events printed on the terminal. You can try generating some more activity by leaving <strong>Kunai</strong> to run in a corner and use your system as you are used to. You can then stop it using <code>Ctrl + c</code>. </p><p>If you inspect the logs in <code>/tmp/kunai.log</code>, you will most likely find a wealth of useful information, especially if you have security monitoring needs. However, you may also come to the conclusion that there is simply too much useless information for your specific needs. So one can use <a href="/docs/advanced/rule_configuration">filtering / detection rules</a> to be very selective of the events (out of scope for this post) or use <strong>IoC</strong> matching, to only display events matching an <strong>IoC</strong>. So lets do the exact same experiment as previously, but taking a file containing <strong>IoCs</strong> as parameter.</p><p>The first thing you need to do is to copy the following content into a file, let&#x27;s say <code>/tmp/kunai-iocs.json</code>:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;81050c82-68a5-4130-a56d-a465c8337066&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;My MISP Instance&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;value&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;why.kunai.rocks&quot;</span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">{</span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;dd19ecd1-8237-427a-9b1d-35ff7d17381f&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;My MISP Instance&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token property" style="color:#9a86fd">&quot;value&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token string" style="color:#ffcc99">&quot;kunai.rocks&quot;</span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once this is done, start <strong>Kunai</strong>, passing this <strong>IoC file</strong> in the command line:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token function" style="color:#9a86fd">sudo</span><span class="token plain"> kunai </span><span class="token parameter variable" style="color:#ffcc99">-i</span><span class="token plain"> /tmp/kunai-iocs.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And now the magic happens! You won&#x27;t see logs any longer, but don&#x27;t worry it is absolutely normal. Under the hood, <strong>Kunai</strong> is analyzing all the events (as the ones you saw in previous experiments) but it will only display the ones matching <strong>IoCs</strong>. So try to generate some network traffic (use <code>dig</code>, <code>curl</code> ...) towards domain <code>why.kunai.rocks</code> and you should see some events popping up on your terminal. If you visit the website with your browser, make sure it <strong>doesn&#x27;t use DOH</strong> or any <strong>DNS</strong> protocol different from the one running on port <strong>53.</strong></p><p>If you did the experiment and managed to generate an event matching one of the <strong>IoCs</strong> configured, you may have seen that the generated events contains <strong>additional information</strong> about the <strong>matching IoC</strong> in the <code>.detection</code> section of the event.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;data&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;ancestors&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/lib/systemd/systemd|/usr/bin/login|/usr/bin/zsh|/usr/bin/bash|/usr/bin/xinit|/usr/bin/i3|/usr/bin/bash|/usr/bin/urxvt|/usr/bin/zsh&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;command_line&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;dig why.kunai.rocks&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;exe&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;file&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;/usr/bin/dig&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;query&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;why.kunai.rocks&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;proto&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;udp&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;response&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai-project.github.io&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;dns_server&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;ip&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;10.96.0.1&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;port&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">53</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;public&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ffcc99">false</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;is_v6&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token boolean" style="color:#ffcc99">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;detection&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;iocs&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token string" style="color:#ffcc99">&quot;why.kunai.rocks&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">]</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;severity&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token property" style="color:#9a86fd">&quot;info&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;host&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;...&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;event&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;source&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;kunai&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;id&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">61</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;name&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;dns_query&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;uuid&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;7cf3a92b-b8fd-9035-4ced-8ca216adbf32&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token property" style="color:#9a86fd">&quot;batch&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token number" style="color:#e09142">38</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;...&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;parent_task&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;...&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token property" style="color:#9a86fd">&quot;utc_time&quot;</span><span class="token operator" style="color:#e09142">:</span><span class="token plain"> </span><span class="token string" style="color:#ffcc99">&quot;2024-04-18T09:34:31.887637287Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above example, we see only one <strong>IoC</strong> under the <code>detection</code> section, however if several <strong>IoCs</strong> would match an event, all of them would be in the list. Things should be a bit more concrete for you now, so lets dive into how to automatically ingest <strong>MISP IoCs</strong> into <strong>Kunai</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-misp-iocs-into-kunai">Getting MISP IoCs into Kunai<a href="#getting-misp-iocs-into-kunai" class="hash-link" aria-label="Direct link to Getting MISP IoCs into Kunai" title="Direct link to Getting MISP IoCs into Kunai">​</a></h2><p>The only thing which is missing, in order to configure <strong>Kunai</strong> from a <strong>MISP instance</strong>, is a way to  extract <strong>IoCs</strong> and translate them into the expected format. If you have already played with <a href="https://github.com/MISP/PyMISP" target="_blank" rel="noopener noreferrer">PyMISP</a>, this is not something that should be too scary and if you have not, here is the good news: we have a script which does it for you.  You can find the script in question over at the <a href="https://github.com/kunai-project/tools" target="_blank" rel="noopener noreferrer">Kunai tools repository</a> under the <a href="https://github.com/kunai-project/tools/tree/main/misp" target="_blank" rel="noopener noreferrer">misp</a> directory. </p><p>Before going further, make sure you have all the modules required (check out <a href="https://github.com/kunai-project/tools/blob/main/requirements.txt" target="_blank" rel="noopener noreferrer">requirements.txt</a> at repository root) by Python so that this script works. </p><p>The next step is to create a configuration file for the script, simply rename the example configuration into <code>config.toml</code> and edit it so that it contains the settings to connect to the desired <strong>MISP</strong> instance.</p><p>If you have fulfilled the previous steps, you can simply run the <code>misp-to-kunai.py</code> script and you should see your <strong>MISP&#x27;s attributes</strong>  translated into <strong>Kunai IoC format</strong> flowing in your terminal. This script has some options to be more selective on the <strong>IoC</strong>s to pull, however we will not go through all of them and will let the reader explore them. The only option we will use is the <code>-o</code> to write <strong>IoC</strong>s into a file. We encourage you to use the <code>-o</code> option to write into a file rather than doing a pure shell redirect as <strong>this option prevents IoC duplication</strong>.</p><p>If you take a look at the output generated by <code>misp-to-kunai.py</code> you may have noticed that <strong>IoCs</strong> are not exactly in the same format as the one described previously. Indeed, those contain an additional field - it being the <code>event_uuid</code> field -, which encodes the <strong>MISP Event UUID</strong> that the <strong>IoC</strong> belongs to. Any additional field to the ones described above, is ignored by <strong>Kunai</strong>, making the <strong>IoC</strong> format fairly flexible. Thanks to this you can add as many fields as you want, for instance to bring contextual information along with the <strong>IoC</strong>. We thought this one would be useful to enrich the <strong>IoC</strong> file with additional context, in case you would wish to correlate back to a <strong>MISP Event</strong>.</p><p>It is now time to put everything together:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#6c6783"># pull IoCs from MISP and store them in Kunai IoC format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">./misp-to-kunai.py </span><span class="token parameter variable" style="color:#ffcc99">-o</span><span class="token plain"> /tmp/kunai-misp-iocs.json</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># run Kunai and check all events happening on your</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783"># system against MISP IoCs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token function" style="color:#9a86fd">sudo</span><span class="token plain"> kunai </span><span class="token parameter variable" style="color:#ffcc99">-i</span><span class="token plain"> /tmp/kunai-misp-iocs.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As seen in the previous experiment, you should not see any event coming out of <strong>Kunai</strong> until one actually matches an <strong>IoC</strong> you&#x27;ve just loaded. The easiest way to try and see if everything works as expected is to execute a <code>dig</code> command against a domain from the <strong>IoC</strong> list.</p><p>Yes, you went though this entire blog post just to end up typing two simple lines into a shell, but now you understand why you typed those and how all this works.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="final-words">Final Words<a href="#final-words" class="hash-link" aria-label="Direct link to Final Words" title="Direct link to Final Words">​</a></h2><p>This post aimed at being dense and straightforward, mostly to prevent you from giving up. While monitoring an infrastructure, <strong>IoC</strong> checking is mandatory, not to miss &quot;known things&quot;. On the other hand, <strong>IoC</strong> do not offer too much flexibility in the sense they cannot be used to detect Tactics, Techniques and Procedures (TTP) used by attackers. So if you would like to go further on this topic, we encourage you to learn <a href="/docs/advanced/rule_configuration">how to configure Kunai with rules</a>.</p><p>On the Python script side, there are also some interesting options deserving exploration, especially if you are interested in turning it into a service.</p><p>All the tools presented here are <strong>open-source</strong>, so feel free to read the code, modify it and contribute to it even in the form of feedback or GitHub issues. This is how we can keep improving our projects and better fit the users&#x27; needs.</p><p>We hope you learned useful things or at least that you enjoyed reading this article.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2><p><a href="https://github.com/kunai-project/" target="_blank" rel="noopener noreferrer">Kunai project on GitHub</a><br>
<a href="/docs/quickstart">Kunai documentation</a><br>
<a href="https://github.com/kunai-project/tools" target="_blank" rel="noopener noreferrer">Kunai tools</a><br>
<a href="https://www.misp-project.org/" target="_blank" rel="noopener noreferrer">MISP</a><br>
<a href="https://github.com/MISP/PyMISP" target="_blank" rel="noopener noreferrer">PyMISP</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/bpf-door-case-study">BPFDoor case study</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-02T13:37:00.000Z" itemprop="datePublished">November 2, 2023</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/qjerome.png" alt="Quentin Jerome"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Quentin Jerome</span></a></div><small class="avatar__subtitle" itemprop="description">Kunai Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This blog post is meant to give an insight of how to use Kunai for detection engineering.</p><p>For those who didn&#x27;t have the opportunity to attend the Kunai workshop at <a href="https://hack.lu" target="_blank" rel="noopener noreferrer">Hack.lu 2023 edition</a> this is a way to catch up on a big part of what we have been doing during this session. For those who actually attended the workshop, you can take a read anyway because the post goes even more into the details, as we were limited in time.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/malware">malware</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/detection-engineering">detection-engineering</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about BPFDoor case study" href="/blog/bpf-door-case-study"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/announcing-kunai">Announcing Kunai</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-06-23T00:00:00.000Z" itemprop="datePublished">June 23, 2023</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/qjerome.png" alt="Quentin Jerome"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/qjerome" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Quentin Jerome</span></a></div><small class="avatar__subtitle" itemprop="description">Kunai Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-kunai">Why Kunai<a href="#why-kunai" class="hash-link" aria-label="Direct link to Why Kunai" title="Direct link to Why Kunai">​</a></h2><p>Because you guys are ninjas !</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/announcement">announcement</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/quickstart">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/AUMaBvHvNU" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://infosec.exchange/@kunai_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/kunai_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">X/Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kunai-project/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Kunai Project, Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4fe196cd.js"></script>
<script src="/assets/js/main.9b770a5a.js"></script>
</body>
</html>